####################################################################################################
#####                              TX Ultimate Easy for ESPHome                                #####
#####                  Repository: https://github.com/edwardtfn/TX-Ultimate-Easy               #####
####################################################################################################
##### Purpose: ESPHome - Common                                                                #####
####################################################################################################
##### Author: edwardtfn - https://github.com/edwardtfn - https://buymeacoffee.com/edwardfirmo  #####
####################################################################################################
##### NOTE:                                                                                    #####
##### - Make changes ONLY if absolutely necessary and you have the required knowledge.         #####
##### - For normal system use, modifications to this file are NOT required.                    #####
####################################################################################################
---
substitutions:
  name: tx-ultimate-easy
  friendly_name: TX Ultimate Easy
  model: XX  # Could be either `EU` or `US`
  gangs: -1  # Number of relays and buttons: `1`, `2`, `3` or `4`

  IS_EU_MODEL: ${'true' if model == "EU" else 'false'}
  IS_US_MODEL: ${'true' if model == "US" else 'false'}

  <<: !include ../versioning/VERSION_YAML

  EVENT_NAME: esphome.tx_ultimate_easy

  DUMP_CONFIG_CALLER_DELAY: 5s  # Delay to dump config after requested

  TAG_COMMON: tx_ultimate_easy.common

api:
  id: api_server
  homeassistant_services: true
  on_client_connected:
    then:
      - script.execute: dump_config_caller

binary_sensor:
  - id: bs_pending_restart
    name: Pending Restart Status
    internal: false
    disabled_by_default: false
    platform: template
    entity_category: diagnostic
    device_class: problem
    on_state:
      then:
        - script.execute: dump_config_caller

  - id: bs_boot_completed
    name: Boot Completed
    internal: false
    disabled_by_default: false
    platform: template
    entity_category: diagnostic
    device_class: connectivity
    icon: mdi:rocket-launch
    on_state:
      then:
        - script.execute: dump_config_caller

button:
  - id: bt_restart
    name: Restart
    internal: false
    platform: restart

esp32:
  board: esp32dev
  flash_size: 8MB
  framework:
    type: esp-idf
    advanced:
      loop_task_stack_size: 16384
    sdkconfig_options:
      CONFIG_ESP32_REV_MIN_3: y  # Require ESP32 revision 3 or newer

esphome:
  name: ${name}
  friendly_name: ${friendly_name}
  comment: TX Ultimate Easy
  min_version: 2025.11.0
  project:
    name: "edwardtfn.tx_ultimate_easy"
    version: ${version}
  platformio_options:
    build_flags:
      - -D TX_ULTIMATE_EASY_COMMON
      - -D TX_ULTIMATE_EASY_FIRMWARE_VERSION="${version}"
      - -D TX_ULTIMATE_EASY_MODEL="${model}"
      - -D TX_ULTIMATE_EASY_GANGS=${gangs}
      - -D TX_ULTIMATE_EASY_IS_EU_MODEL=${1 if model == "EU" else 0}
      - -D TX_ULTIMATE_EASY_IS_US_MODEL=${1 if model == "US" else 0}

  on_boot:
    - priority: 1000  # Very early in boot process
      then:
        - binary_sensor.template.publish:
            id: bs_boot_completed
            state: OFF  # yamllint disable-line rule:truthy

    - priority: 750
      then:
        - script.execute: restore_from_nvs

    - priority: 700
      then:
        - script.execute: boot_initialize

    - priority: 600  # This is where most sensors are set up.
      then:
        - script.execute: boot_sequence

    - priority: -100  # At this priority, pretty much everything should already be initialized.
      then:
        - script.execute: boot_done

external_components:
  - source:
      type: git
      url: https://github.com/edwardtfn/TX-Ultimate-Easy
      ref: v${version}
    refresh: 1h
    components:
      - tx_ultimate_easy

logger:
  level: DEBUG

ota:
  platform: esphome

psram:

script:
  - id: api_send_ha_event_boot
    mode: queued
    parameters:
      type: string
    then:
      - lambda: |-
          // Send event to Home Assistant
          esphome::tx_ultimate_easy::fire_ha_event("boot", type.c_str(), {});

  - id: boot_done
    mode: restart
    then:
      - script.wait: restore_from_nvs
      - script.wait: boot_initialize
      - script.wait: boot_sequence
      - script.execute:
          id: api_send_ha_event_boot
          type: done
      - script.wait: api_send_ha_event_boot
      - binary_sensor.template.publish:
          id: bs_boot_completed
          state: ON  # yamllint disable-line rule:truthy

  - id: boot_initialize
    mode: restart
    then:
      # Extended by:
      #   - HW Buttons
      #   - HW Relays
      #   - HW Touch
      - script.execute: update_device_name
      - script.execute:
          id: api_send_ha_event_boot
          type: start

  - id: boot_sequence
    mode: restart
    then:
      - binary_sensor.template.publish:
          id: bs_pending_restart
          state: false

  - id: dump_config
    mode: restart
    then:
      # Extended by all modules
      - lambda: |-
          // Device identification
          ESP_LOGCONFIG("${TAG_COMMON}", "Device friendly name: ${friendly_name}");
          ESP_LOGCONFIG("${TAG_COMMON}", "Device name: ${name}");
          ESP_LOGCONFIG("${TAG_COMMON}", "Device name (HA): %s", esphome::tx_ultimate_easy::cached_device_name.c_str());
          ESP_LOGCONFIG("${TAG_COMMON}", "Device hostname: %s", App.get_name().c_str());

          dump_config_versions->execute();

          // Framework detection
          #ifdef USE_ARDUINO
          ESP_LOGCONFIG("${TAG_COMMON}", "Framework: Arduino");
          #elif defined(USE_ESP_IDF)
          ESP_LOGCONFIG("${TAG_COMMON}", "Framework: ESP-IDF");
          #else
          ESP_LOGW("${TAG_COMMON}", "Framework: UNKNOWN");
          #endif

          // Model configuration
          ESP_LOGCONFIG("${TAG_COMMON}", "Model: ${model}-${gangs}G");
          if (${gangs} < 1 || ${gangs} > 4) {
            ESP_LOGE("${TAG_COMMON}", "Invalid number of gangs: ${gangs}");
          }

          // Boot completion status
          if (bs_boot_completed->state)
            ESP_LOGCONFIG("${TAG_COMMON}", "Boot completed: Yes");
          else
            ESP_LOGW("${TAG_COMMON}", "Boot completed: NO");

          // System state
          if (bs_pending_restart->state)
            ESP_LOGW("${TAG_COMMON}", "Pending restart: YES");
          else
            ESP_LOGCONFIG("${TAG_COMMON}", "Pending restart: No");

          // =============================================================================
          // Compile-time validation of required configuration parameters
          // =============================================================================

          // Validate 'gangs' substitution exists
          #ifndef TX_ULTIMATE_EASY_GANGS
            #error "CONFIGURATION ERROR: Missing required 'gangs' substitution. Update your YAML adding 'gangs: 1' to your substitutions (valid values: 1, 2, 3, or 4)"
          #endif  // !TX_ULTIMATE_EASY_GANGS

          // Validate 'gangs' value is in valid range (1-4)
          #if defined(TX_ULTIMATE_EASY_GANGS) && (TX_ULTIMATE_EASY_GANGS < 1 || TX_ULTIMATE_EASY_GANGS > 4)
            #error "CONFIGURATION ERROR: Invalid 'gangs' value. Must be between 1 and 4. Update your YAML changing 'gangs' in your substitutions to a valid value (1, 2, 3, or 4)"
          #endif  // TX_ULTIMATE_EASY_GANGS range validation

          // Validate 'model' substitution exists (check for model flags)
          #if !defined(TX_ULTIMATE_EASY_IS_EU_MODEL) || !defined(TX_ULTIMATE_EASY_IS_US_MODEL)
            #error "CONFIGURATION ERROR: Missing required 'model' substitution. Update your YAML adding 'model: EU' or 'model: US' to your substitutions"
          #endif  // Model flags existence check

          // Validate 'model' value is either 'EU' or 'US' (exactly one flag should be true)
          #if (TX_ULTIMATE_EASY_IS_EU_MODEL && TX_ULTIMATE_EASY_IS_US_MODEL) || \
              (!TX_ULTIMATE_EASY_IS_EU_MODEL && !TX_ULTIMATE_EASY_IS_US_MODEL)
            #error "CONFIGURATION ERROR: Invalid 'model' value. Must be either 'EU' or 'US' (case-sensitive). Update your YAML adding 'model: EU' or 'model: US' to your substitutions"
          #endif  // Model value validation

          // =============================================================================

  - id: dump_config_caller
    mode: restart
    then:
      - delay: ${DUMP_CONFIG_CALLER_DELAY}
      - script.execute: dump_config
      - script.wait: dump_config
      - script.execute: dump_config_list_packages

  - id: dump_config_list_packages
    mode: restart
    then:
      - script.wait: dump_config
      - lambda: |-
          ESP_LOGCONFIG(ESPHOME_PROJECT_NAME, "Installed packages:");

          // Identify itself
          ESP_LOGCONFIG(ESPHOME_PROJECT_NAME, "  - Core");

  - id: dump_config_versions
    mode: restart
    then:
      - lambda: |-
          // Version information
          ESP_LOGCONFIG("${TAG_COMMON}", "TX Ultimate firmware version: ${version}");
          // ESPHome builder information
          ESP_LOGCONFIG("${TAG_COMMON}", "ESPHome builder: " ESPHOME_VERSION);
          ESP_LOGCONFIG("${TAG_COMMON}", "ESPHome build timestamp: %s", App.get_compilation_time().c_str());

  - id: restore_from_nvs
    mode: single
    then:

  - id: update_device_name
    mode: single
    then:
      - lambda: |-
          if (esphome::tx_ultimate_easy::cached_device_name.empty()) {
            esphome::tx_ultimate_easy::initialize_cached_device_name(App.get_name());
            ESP_LOGI("${TAG_COMMON}", "Device name: %s", esphome::tx_ultimate_easy::cached_device_name.c_str());
            tx_device_name->publish_state(esphome::tx_ultimate_easy::cached_device_name);
          }

text_sensor:
  - id: tx_fw_version
    name: TX Ultimate Easy Firmware Version
    platform: template
    entity_category: diagnostic
    icon: mdi:tag-text-outline
    internal: false
    update_interval: never
    lambda: |-
      return {"${version}"};

  - id: tx_device_name
    name: Device Name
    platform: template
    icon: mdi:identifier
    entity_category: diagnostic
    internal: false
    disabled_by_default: false
    update_interval: never
    lambda: |-
      return { esphome::tx_ultimate_easy::cached_device_name };

tx_ultimate_easy:
  id: tx_ultimate

wifi:
  id: wifi_component
  use_psram: true

  on_connect:
    then:
      - lambda: |-
          tx_fw_version->publish_state("${version}");
          update_device_name->execute();
...
