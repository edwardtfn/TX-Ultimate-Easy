####################################################################################################
#####                              TX Ultimate Easy for ESPHome                                #####
#####                  Repository: https://github.com/edwardtfn/TX-Ultimate-Easy               #####
####################################################################################################
##### Purpose: ESPHome - Hardware - Relays                                                     #####
####################################################################################################
##### Author: edwardtfn - https://github.com/edwardtfn - https://buymeacoffee.com/edwardfirmo  #####
####################################################################################################
##### NOTE:                                                                                    #####
##### - Make changes ONLY if absolutely necessary and you have the required knowledge.         #####
##### - For normal system use, modifications to this file are NOT required.                    #####
####################################################################################################
---
substitutions:
  expose_relays_leds_to_ha: false

  RELAY_MODE_TEXT_SWITCH: "Switch"
  RELAY_MODE_TEXT_LIGHT: "Light"
  RELAY_MODE_TEXT_NOT_USED: "Not in use"

  # You shouldn't change the restore mode as there is a custom restoring engine based on globals.
  # The reason of a custom engine is to address an issue where NVS space was exceeded causing saving/restoring issues
  RELAYS_LIGHT_RESTORE_MODE: RESTORE_DEFAULT_OFF
  RELAYS_LIGHT_PARTITION_RESTORE_MODE: RESTORE_DEFAULT_OFF
  RELAYS_EXPOSE_LEDS_TO_HA_RESTORE_MODE: RESTORE_DEFAULT_OFF
  RELAYS_SWITCH_RESTORE_MODE: RESTORE_DEFAULT_OFF

  TAG_HW_RELAYS: tx_ultimate_easy.hw.relays

esphome:
  platformio_options:
    build_flags:
      - -D TX_ULTIMATE_EASY_HW_RELAYS

globals:
  - id: boot_initialization_relays
    type: bool
    restore_value: false
    initial_value: 'false'
  - id: boot_initialization_relays_group_assignments
    type: bool
    restore_value: false
    initial_value: 'false'
  - id: boot_initialization_relays_light_modes
    type: bool
    restore_value: false
    initial_value: 'false'
  - id: boot_initialization_relays_relay_modes
    type: bool
    restore_value: false
    initial_value: 'false'

  - id: gb_lights_1
    type: std::vector<light::LightState*>
    restore_value: false
  - id: gb_lights_2
    type: std::vector<light::LightState*>
    restore_value: false

  - id: relay_1_state
    type: bool
    initial_value: 'false'
  - id: relay_2_state
    type: bool
    initial_value: 'false'
  - id: relay_3_state
    type: bool
    initial_value: 'false'
  - id: relay_4_state
    type: bool
    initial_value: 'false'

light:
  # These lights are used for the physical relays to be shown as lights
  - id: light_output_1
    name: Light output 1
    output: output_relay_1
    platform: binary
    internal: true
    restore_mode: ${RELAYS_LIGHT_RESTORE_MODE}
    on_turn_on:
      then:
        - script.execute: show_relay_status
    on_turn_off:
      then:
        - script.execute: show_relay_status
  - id: light_output_2
    name: Light output 2
    output: output_relay_2
    platform: binary
    internal: true
    restore_mode: ${RELAYS_LIGHT_RESTORE_MODE}
    on_turn_on:
      then:
        - script.execute: show_relay_status
    on_turn_off:
      then:
        - script.execute: show_relay_status
  - id: light_output_3
    name: Light output 3
    output: output_relay_3
    platform: binary
    internal: true
    restore_mode: ${RELAYS_LIGHT_RESTORE_MODE}
    on_turn_on:
      then:
        - script.execute: show_relay_status
    on_turn_off:
      then:
        - script.execute: show_relay_status
  - id: light_output_4
    name: Light output 4
    output: output_relay_4
    platform: binary
    internal: true
    restore_mode: ${RELAYS_LIGHT_RESTORE_MODE}
    on_turn_on:
      then:
        - script.execute: show_relay_status
    on_turn_off:
      then:
        - script.execute: show_relay_status

  # These lights are used to indicate relay's statuses
  - &light_partition_relays
    id: light_rl_1_1_${LIGHT_MODE_BOTTOM_OR_LEFT_TEXT}
    name: Light - Relay 1 of 1 (${LIGHT_MODE_BOTTOM_OR_LEFT_TEXT})
    platform: partition
    internal: ${not expose_relays_leds_to_ha and gang_count != 1}
    disabled_by_default: false
    default_transition_length: ${default_transition_length}
    restore_mode: ${RELAYS_LIGHT_PARTITION_RESTORE_MODE}
    segments:
      - id: light_full
        from: ${9 if IS_EU_MODEL else 15}
        to: ${9 if IS_EU_MODEL else 24}
  - id: light_rl_1_1_${LIGHT_MODE_TOP_OR_RIGHT_TEXT}
    name: Light - Relay 1 of 1 (${LIGHT_MODE_TOP_OR_RIGHT_TEXT})
    internal: ${not expose_relays_leds_to_ha and gang_count != 1}
    <<: *light_partition_relays
    segments:
      - id: light_full
        from: ${23 if IS_EU_MODEL else 31}
        to: ${23 if IS_EU_MODEL else 31}
      - id: light_full
        from: ${23 if IS_EU_MODEL else 0}
        to: ${23 if IS_EU_MODEL else 8}
  - id: light_rl_1_2_${LIGHT_MODE_BOTTOM_OR_LEFT_TEXT}
    name: Light - Relay 1 of 2 (${LIGHT_MODE_BOTTOM_OR_LEFT_TEXT})
    internal: ${not expose_relays_leds_to_ha and gang_count != 2}
    <<: *light_partition_relays
    segments:
      - id: light_full
        from: ${11 if IS_EU_MODEL else 20}
        to: ${11 if IS_EU_MODEL else 24}
  - id: light_rl_1_2_${LIGHT_MODE_TOP_OR_RIGHT_TEXT}
    name: Light - Relay 1 of 2 (${LIGHT_MODE_TOP_OR_RIGHT_TEXT})
    internal: ${not expose_relays_leds_to_ha and gang_count != 2}
    <<: *light_partition_relays
    segments:
      - id: light_full
        from: ${21 if IS_EU_MODEL else 31}
        to: ${21 if IS_EU_MODEL else 31}
      - id: light_full
        from: ${21 if IS_EU_MODEL else 0}
        to: ${21 if IS_EU_MODEL else 3}
  - id: light_rl_2_2_${LIGHT_MODE_BOTTOM_OR_LEFT_TEXT}
    name: Light - Relay 2 of 2 (${LIGHT_MODE_BOTTOM_OR_LEFT_TEXT})
    internal: ${not expose_relays_leds_to_ha and gang_count != 2}
    <<: *light_partition_relays
    segments:
      - id: light_full
        from: ${7 if IS_EU_MODEL else 15}
        to: ${7 if IS_EU_MODEL else 19}
  - id: light_rl_2_2_${LIGHT_MODE_TOP_OR_RIGHT_TEXT}
    name: Light - Relay 2 of 2 (${LIGHT_MODE_TOP_OR_RIGHT_TEXT})
    internal: ${not expose_relays_leds_to_ha and gang_count != 2}
    <<: *light_partition_relays
    segments:
      - id: light_full
        from: ${25 if IS_EU_MODEL else 4}
        to: ${25 if IS_EU_MODEL else 8}
  - id: light_rl_1_3_${LIGHT_MODE_BOTTOM_OR_LEFT_TEXT}
    name: Light - Relay 1 of 3 (${LIGHT_MODE_BOTTOM_OR_LEFT_TEXT})
    internal: ${not expose_relays_leds_to_ha and gang_count != 3}
    <<: *light_partition_relays
    segments:
      - id: light_full
        from: ${12 if IS_EU_MODEL else 22}
        to: ${12 if IS_EU_MODEL else 23}
  - id: light_rl_1_3_${LIGHT_MODE_TOP_OR_RIGHT_TEXT}
    name: Light - Relay 1 of 3 (${LIGHT_MODE_TOP_OR_RIGHT_TEXT})
    internal: ${not expose_relays_leds_to_ha and gang_count != 3}
    <<: *light_partition_relays
    segments:
      - id: light_full
        from: ${20 if IS_EU_MODEL else 0}
        to: ${20 if IS_EU_MODEL else 1}
  - id: light_rl_2_3_${LIGHT_MODE_BOTTOM_OR_LEFT_TEXT}
    name: Light - Relay 2 of 3 (${LIGHT_MODE_BOTTOM_OR_LEFT_TEXT})
    internal: ${not expose_relays_leds_to_ha and gang_count != 3}
    <<: *light_partition_relays
    segments:
      - id: light_full
        from: ${9 if IS_EU_MODEL else 19}
        to: ${9 if IS_EU_MODEL else 20}
  - id: light_rl_2_3_${LIGHT_MODE_TOP_OR_RIGHT_TEXT}
    name: Light - Relay 2 of 3 (${LIGHT_MODE_TOP_OR_RIGHT_TEXT})
    internal: ${not expose_relays_leds_to_ha and gang_count != 3}
    <<: *light_partition_relays
    segments:
      - id: light_full
        from: ${23 if IS_EU_MODEL else 3}
        to: ${23 if IS_EU_MODEL else 4}
  - id: light_rl_3_3_${LIGHT_MODE_BOTTOM_OR_LEFT_TEXT}
    name: Light - Relay 3 of 3 (${LIGHT_MODE_BOTTOM_OR_LEFT_TEXT})
    internal: ${not expose_relays_leds_to_ha and gang_count != 3}
    <<: *light_partition_relays
    segments:
      - id: light_full
        from: ${6 if IS_EU_MODEL else 16}
        to: ${6 if IS_EU_MODEL else 17}
  - id: light_rl_3_3_${LIGHT_MODE_TOP_OR_RIGHT_TEXT}
    name: Light - Relay 3 of 3 (${LIGHT_MODE_TOP_OR_RIGHT_TEXT})
    internal: ${not expose_relays_leds_to_ha and gang_count != 3}
    <<: *light_partition_relays
    segments:
      - id: light_full
        from: ${26 if IS_EU_MODEL else 6}
        to: ${26 if IS_EU_MODEL else 7}
  - id: light_rl_1_4_${LIGHT_MODE_BOTTOM_OR_LEFT_TEXT}
    name: Light - Relay 1 of 4 (${LIGHT_MODE_BOTTOM_OR_LEFT_TEXT})
    internal: ${not expose_relays_leds_to_ha and gang_count != 4}
    <<: *light_partition_relays
    segments:
      - id: light_full
        from: ${12 if IS_EU_MODEL else 23}
        to: ${12 if IS_EU_MODEL else 24}
  - id: light_rl_1_4_${LIGHT_MODE_TOP_OR_RIGHT_TEXT}
    name: Light - Relay 1 of 4 (${LIGHT_MODE_TOP_OR_RIGHT_TEXT})
    internal: ${not expose_relays_leds_to_ha and gang_count != 4}
    <<: *light_partition_relays
    segments:
      - id: light_full
        from: ${20 if IS_EU_MODEL else 31}
        to: ${20 if IS_EU_MODEL else 31}
      - id: light_full
        from: ${20 if IS_EU_MODEL else 0}
        to: ${20 if IS_EU_MODEL else 0}
  - id: light_rl_2_4_${LIGHT_MODE_BOTTOM_OR_LEFT_TEXT}
    name: Light - Relay 2 of 4 (${LIGHT_MODE_BOTTOM_OR_LEFT_TEXT})
    internal: ${not expose_relays_leds_to_ha and gang_count != 4}
    <<: *light_partition_relays
    segments:
      - id: light_full
        from: ${10 if IS_EU_MODEL else 21}
        to: ${10 if IS_EU_MODEL else 22}
  - id: light_rl_2_4_${LIGHT_MODE_TOP_OR_RIGHT_TEXT}
    name: Light - Relay 2 of 4 (${LIGHT_MODE_TOP_OR_RIGHT_TEXT})
    internal: ${not expose_relays_leds_to_ha and gang_count != 4}
    <<: *light_partition_relays
    segments:
      - id: light_full
        from: ${22 if IS_EU_MODEL else 1}
        to: ${22 if IS_EU_MODEL else 2}
  - id: light_rl_3_4_${LIGHT_MODE_BOTTOM_OR_LEFT_TEXT}
    name: Light - Relay 3 of 4 (${LIGHT_MODE_BOTTOM_OR_LEFT_TEXT})
    internal: ${not expose_relays_leds_to_ha and gang_count != 4}
    <<: *light_partition_relays
    segments:
      - id: light_full
        from: ${8 if IS_EU_MODEL else 17}
        to: ${8 if IS_EU_MODEL else 18}
  - id: light_rl_3_4_${LIGHT_MODE_TOP_OR_RIGHT_TEXT}
    name: Light - Relay 3 of 4 (${LIGHT_MODE_TOP_OR_RIGHT_TEXT})
    internal: ${not expose_relays_leds_to_ha and gang_count != 4}
    <<: *light_partition_relays
    segments:
      - id: light_full
        from: ${24 if IS_EU_MODEL else 5}
        to: ${24 if IS_EU_MODEL else 6}
  - id: light_rl_4_4_${LIGHT_MODE_BOTTOM_OR_LEFT_TEXT}
    name: Light - Relay 4 of 4 (${LIGHT_MODE_BOTTOM_OR_LEFT_TEXT})
    internal: ${not expose_relays_leds_to_ha and gang_count != 4}
    <<: *light_partition_relays
    segments:
      - id: light_full
        from: ${6 if IS_EU_MODEL else 15}
        to: ${6 if IS_EU_MODEL else 16}
  - id: light_rl_4_4_${LIGHT_MODE_TOP_OR_RIGHT_TEXT}
    internal: ${not expose_relays_leds_to_ha and gang_count != 4}
    name: Light - Relay 4 of 4 (${LIGHT_MODE_TOP_OR_RIGHT_TEXT})
    <<: *light_partition_relays
    segments:
      - id: light_full
        from: ${26 if IS_EU_MODEL else 7}
        to: ${26 if IS_EU_MODEL else 8}

output:
  - id: output_relay_1
    platform: gpio
    pin: GPIO18
  - id: output_relay_2
    platform: gpio
    pin: GPIO17
  - id: output_relay_3
    platform: gpio
    pin: GPIO27
  - id: output_relay_4
    platform: gpio
    pin: GPIO23

script:
  - id: !extend boot_initialize
    then:
      - script.execute: boot_initialize_relays

  - id: boot_initialize_relays
    mode: restart
    then:
      - script.execute: boot_initialize_relays_group_assignments
      - script.execute: boot_initialize_relays_light_modes
      - script.execute: boot_initialize_relays_relay_modes
      - script.wait: boot_initialize_relays_group_assignments
      - script.wait: boot_initialize_relays_light_modes
      - script.wait: boot_initialize_relays_relay_modes
      - wait_until:
          condition:
            - lambda: return id(boot_initialization_relays_group_assignments);
            - lambda: return id(boot_initialization_relays_light_modes);
            - lambda: return id(boot_initialization_relays_relay_modes);
      - globals.set:
          id: boot_initialization_relays
          value: 'true'

  - id: boot_initialize_relays_group_assignments
    mode: restart
    then:
      - lambda: |-
          // LED Group Assignment:
          // - For US model: gb_lights_1 = left side LEDs, gb_lights_2 = right side LEDs
          // - For EU model: gb_lights_1 = bottom LEDs, gb_lights_2 = top LEDs
          // Gang configurations determine which LED segments are active
          #if defined(TX_ULTIMATE_EASY_GANG_COUNT) && (TX_ULTIMATE_EASY_GANG_COUNT == 1)
          id(gb_lights_1) = { light_rl_1_1_${LIGHT_MODE_BOTTOM_OR_LEFT_TEXT} };
          id(gb_lights_2) = { light_rl_1_1_${LIGHT_MODE_TOP_OR_RIGHT_TEXT} };
          #elif (TX_ULTIMATE_EASY_GANG_COUNT == 2)
          id(gb_lights_1) = { light_rl_1_2_${LIGHT_MODE_BOTTOM_OR_LEFT_TEXT},
                              light_rl_2_2_${LIGHT_MODE_BOTTOM_OR_LEFT_TEXT} };
          id(gb_lights_2) = { light_rl_1_2_${LIGHT_MODE_TOP_OR_RIGHT_TEXT},
                              light_rl_2_2_${LIGHT_MODE_TOP_OR_RIGHT_TEXT} };
          #elif (TX_ULTIMATE_EASY_GANG_COUNT == 3)
          id(gb_lights_1) = { light_rl_1_3_${LIGHT_MODE_BOTTOM_OR_LEFT_TEXT},
                              light_rl_2_3_${LIGHT_MODE_BOTTOM_OR_LEFT_TEXT},
                              light_rl_3_3_${LIGHT_MODE_BOTTOM_OR_LEFT_TEXT} };
          id(gb_lights_2) = { light_rl_1_3_${LIGHT_MODE_TOP_OR_RIGHT_TEXT},
                              light_rl_2_3_${LIGHT_MODE_TOP_OR_RIGHT_TEXT},
                              light_rl_3_3_${LIGHT_MODE_TOP_OR_RIGHT_TEXT} };
          #elif (TX_ULTIMATE_EASY_GANG_COUNT == 4)
          id(gb_lights_1) = { light_rl_1_4_${LIGHT_MODE_BOTTOM_OR_LEFT_TEXT},
                              light_rl_2_4_${LIGHT_MODE_BOTTOM_OR_LEFT_TEXT},
                              light_rl_3_4_${LIGHT_MODE_BOTTOM_OR_LEFT_TEXT},
                              light_rl_4_4_${LIGHT_MODE_BOTTOM_OR_LEFT_TEXT} };
          id(gb_lights_2) = { light_rl_1_4_${LIGHT_MODE_TOP_OR_RIGHT_TEXT},
                              light_rl_2_4_${LIGHT_MODE_TOP_OR_RIGHT_TEXT},
                              light_rl_3_4_${LIGHT_MODE_TOP_OR_RIGHT_TEXT},
                              light_rl_4_4_${LIGHT_MODE_TOP_OR_RIGHT_TEXT} };
          #endif
          id(boot_initialization_relays_group_assignments) = true;

  - id: boot_initialize_relays_light_modes
    mode: restart
    then:
      - lambda: |-
          // Set this section of initialization as completed
          id(boot_initialization_relays_light_modes) = true;

  - id: boot_initialize_relays_relay_modes
    mode: restart
    then:
      - lambda: |-
          // Set indicator (either switch or light) visible on Home Assistant
          auto relay_mode_index = sl_relay_1_mode->active_index();
          if (relay_mode_index.has_value()) {
            light_output_1->set_internal(${gang_count} < 1 or relay_mode_index.value() != 1);
            sw_relay_1->set_internal(${gang_count} < 1 or relay_mode_index.value() != 0);
          }
          relay_mode_index = sl_relay_2_mode->active_index();
          if (relay_mode_index.has_value()) {
            light_output_2->set_internal(${gang_count} < 2 or relay_mode_index.value() != 1);
            sw_relay_2->set_internal(${gang_count} < 2 or relay_mode_index.value() != 0);
          }
          relay_mode_index = sl_relay_3_mode->active_index();
          if (relay_mode_index.has_value()) {
            light_output_3->set_internal(${gang_count} < 3 or relay_mode_index.value() != 1);
            sw_relay_3->set_internal(${gang_count} < 3 or relay_mode_index.value() != 0);
          }
          relay_mode_index = sl_relay_4_mode->active_index();
          if (relay_mode_index.has_value()) {
            light_output_4->set_internal(${gang_count} < 4 or relay_mode_index.value() != 1);
            sw_relay_4->set_internal(${gang_count} < 4 or relay_mode_index.value() != 0);
          }

          // Set this section of initialization as completed
          id(boot_initialization_relays_relay_modes) = true;

  - id: !extend button_click_event
    then:
      - lambda: |-
          // Handle only single clicks
          if (click_count != 1) {
            ESP_LOGV("${TAG_HW_RELAYS}", "Clicks: %" PRIu8, click_count);
            return;
          }

          // Ignore if other touch events are active
          if (bs_multi_touch->state ||
              bs_swipe_${ID_SWIPE_LEFT_OR_UP_TEXT}->state ||
              bs_swipe_${ID_SWIPE_RIGHT_OR_DOWN_TEXT}->state) {
            ESP_LOGV("${TAG_HW_RELAYS}", "Multi-touch: %s", YESNO(bs_multi_touch->state));
            ESP_LOGV("${TAG_HW_RELAYS}", "Swipe ${ID_SWIPE_LEFT_OR_UP_TEXT}: %s",
                                          YESNO(bs_swipe_${ID_SWIPE_LEFT_OR_UP_TEXT}->state));
            ESP_LOGV("${TAG_HW_RELAYS}", "Swipe ${ID_SWIPE_RIGHT_OR_DOWN_TEXT}: %s",
                                          YESNO(bs_swipe_${ID_SWIPE_RIGHT_OR_DOWN_TEXT}->state));
            return;
          }

          // Toggle relay if corresponding button action is enabled
          const bool api_disconnected = !global_api_server->is_connected() or
                                        !wifi_component->is_connected();
          std::string select_state;
          bool toggle_relay = false;
          if (api_disconnected) {
            ESP_LOGW("${TAG_HW_RELAYS}", "Toggle relays:");
            ESP_LOGW("${TAG_HW_RELAYS}", "  API state: DISCONNECTED");
            ESP_LOGW("${TAG_HW_RELAYS}", "  Button:    %" PRIu8, button);
          } else {
            ESP_LOGVV("${TAG_HW_RELAYS}", "Toggle relays:");
            ESP_LOGVV("${TAG_HW_RELAYS}", "  API state: Connected");
            ESP_LOGVV("${TAG_HW_RELAYS}", "  Button:    %" PRIu8, button);
          }
          switch (button) {
            case ${BUTTON_1_ID}:
              select_state = sl_button_1_action->current_option();
              toggle_relay = (select_state == "${BUTTON_1_ACTION_TEXT}" or
                              (api_disconnected and select_state == "${BUTTON_1_ACTION_FAILSAFE_TEXT}"));
              if (toggle_relay)
                sw_relay_1->toggle();
              break;
            case ${BUTTON_2_ID}:
              select_state = sl_button_2_action->current_option();
              toggle_relay = (select_state == "${BUTTON_2_ACTION_TEXT}" or
                              (api_disconnected and select_state == "${BUTTON_2_ACTION_FAILSAFE_TEXT}"));
              if (toggle_relay)
                sw_relay_2->toggle();
              break;
            case ${BUTTON_3_ID}:
              select_state = sl_button_3_action->current_option();
              toggle_relay = (select_state == "${BUTTON_3_ACTION_TEXT}" or
                              (api_disconnected and select_state == "${BUTTON_3_ACTION_FAILSAFE_TEXT}"));
              if (toggle_relay)
                sw_relay_3->toggle();
              break;
            case ${BUTTON_4_ID}:
              select_state = sl_button_4_action->current_option();
              toggle_relay = (select_state == "${BUTTON_4_ACTION_TEXT}" or
                              (api_disconnected and select_state == "${BUTTON_4_ACTION_FAILSAFE_TEXT}"));
              if (toggle_relay)
                sw_relay_4->toggle();
              break;
          }
          if (toggle_relay) {
            ESP_LOGI("${TAG_HW_RELAYS}", "Toggle relay %" PRIu8 ": (%s)", button, select_state.c_str());
          } else if (not select_state.empty()) {
            ESP_LOGV("${TAG_HW_RELAYS}", "Ignoring toggle for relay %" PRIu8 ": action is '%s'",
                                        button, select_state.c_str());
          } else {
            ESP_LOGE("${TAG_HW_RELAYS}", "No button action selected for button %" PRIu8, button);
          }

  - id: !extend dump_config
    then:
      - lambda: |-
          // Relay's modes
          #if TX_ULTIMATE_EASY_GANG_COUNT > 1
          ESP_LOGCONFIG("${TAG_HW_RELAYS}", "Relays modes:");
          #else
          ESP_LOGCONFIG("${TAG_HW_RELAYS}", "Relay mode:");
          #endif  // TX_ULTIMATE_EASY_GANG_COUNT > 1
          ESP_LOGCONFIG("${TAG_HW_RELAYS}", "  Relay 1: %s", sl_relay_1_mode->has_state() ?
          #if ESPHOME_VERSION_CODE >= VERSION_CODE(2026, 0, 0)  // Code for ESPHome newer than v2026.0.0
                                                              sl_relay_1_mode->current_option().c_str() : "Unknown");
          #else
                                                              sl_relay_1_mode->current_option() : "Unknown");
          #endif
          #if TX_ULTIMATE_EASY_GANG_COUNT >= 2
          ESP_LOGCONFIG("${TAG_HW_RELAYS}", "  Relay 2: %s", sl_relay_2_mode->has_state() ?
          #if ESPHOME_VERSION_CODE >= VERSION_CODE(2026, 0, 0)  // Code for ESPHome newer than v2026.0.0
                                                              sl_relay_2_mode->current_option().c_str() : "Unknown");
          #else
                                                              sl_relay_2_mode->current_option() : "Unknown");
          #endif
          #endif  // TX_ULTIMATE_EASY_GANG_COUNT >= 2
          #if TX_ULTIMATE_EASY_GANG_COUNT >= 3
          ESP_LOGCONFIG("${TAG_HW_RELAYS}", "  Relay 3: %s", sl_relay_3_mode->has_state() ?
          #if ESPHOME_VERSION_CODE >= VERSION_CODE(2026, 0, 0)  // Code for ESPHome newer than v2026.0.0
                                                              sl_relay_3_mode->current_option().c_str() : "Unknown");
          #else
                                                              sl_relay_3_mode->current_option() : "Unknown");
          #endif
          #endif  // TX_ULTIMATE_EASY_GANG_COUNT >= 3
          #if TX_ULTIMATE_EASY_GANG_COUNT >= 4
          ESP_LOGCONFIG("${TAG_HW_RELAYS}", "  Relay 4: %s", sl_relay_4_mode->has_state() ?
          #if ESPHOME_VERSION_CODE >= VERSION_CODE(2026, 0, 0)  // Code for ESPHome newer than v2026.0.0
                                                              sl_relay_4_mode->current_option().c_str() : "Unknown");
          #else
                                                              sl_relay_4_mode->current_option() : "Unknown");
          #endif
          #endif  // TX_ULTIMATE_EASY_GANG_COUNT >= 4

          // Relay's states
          #if TX_ULTIMATE_EASY_GANG_COUNT > 1
          ESP_LOGCONFIG("${TAG_HW_RELAYS}", "Relays states:");
          #else
          ESP_LOGCONFIG("${TAG_HW_RELAYS}", "Relay state:");
          #endif  // TX_ULTIMATE_EASY_GANG_COUNT > 1
          ESP_LOGCONFIG("${TAG_HW_RELAYS}", "  Relay 1: %s", sw_relay_1->state ? "ON" : "OFF");
          #if TX_ULTIMATE_EASY_GANG_COUNT >= 2
          ESP_LOGCONFIG("${TAG_HW_RELAYS}", "  Relay 2: %s", sw_relay_2->state ? "ON" : "OFF");
          #endif  // TX_ULTIMATE_EASY_GANG_COUNT >= 2
          #if TX_ULTIMATE_EASY_GANG_COUNT >= 3
          ESP_LOGCONFIG("${TAG_HW_RELAYS}", "  Relay 3: %s", sw_relay_3->state ? "ON" : "OFF");
          #endif  // TX_ULTIMATE_EASY_GANG_COUNT >= 3
          #if TX_ULTIMATE_EASY_GANG_COUNT >= 4
          ESP_LOGCONFIG("${TAG_HW_RELAYS}", "  Relay 4: %s", sw_relay_4->state ? "ON" : "OFF");
          #endif  // TX_ULTIMATE_EASY_GANG_COUNT >= 4
          ESP_LOGCONFIG("${TAG_HW_RELAYS}", "Expose Relay's LEDs to Home Assistant: ${expose_relays_leds_to_ha}");

          // Boot initialization statuses
          ESP_LOGCONFIG("${TAG_HW_RELAYS}", "Boot initialization flags:");
          ESP_LOGCONFIG("${TAG_HW_RELAYS}", "  Overall:     %s", YESNO(id(boot_initialization_relays)));
          ESP_LOGCONFIG("${TAG_HW_RELAYS}", "  Groups:      %s", YESNO(id(boot_initialization_relays_group_assignments)));
          ESP_LOGCONFIG("${TAG_HW_RELAYS}", "  Light modes: %s", YESNO(id(boot_initialization_relays_light_modes)));
          ESP_LOGCONFIG("${TAG_HW_RELAYS}", "  Relay modes: %s", YESNO(id(boot_initialization_relays_relay_modes)));

          // Relay's LEDs modes
          #if TX_ULTIMATE_EASY_GANG_COUNT > 1
          ESP_LOGCONFIG("${TAG_HW_RELAYS}", "Relays LEDs modes:");
          #else
          ESP_LOGCONFIG("${TAG_HW_RELAYS}", "Relay LEDs mode:");
          #endif  // TX_ULTIMATE_EASY_GANG_COUNT > 1
          #if ESPHOME_VERSION_CODE >= VERSION_CODE(2026, 0, 0)  // Code for ESPHome newer than v2026.0.0
          ESP_LOGCONFIG("${TAG_HW_RELAYS}", "  Relay 1: %s", sl_relay_1_light_mode->current_option().c_str());
          #else
          ESP_LOGCONFIG("${TAG_HW_RELAYS}", "  Relay 1: %s", sl_relay_1_light_mode->current_option());
          #endif
          #if TX_ULTIMATE_EASY_GANG_COUNT >= 2
          #if ESPHOME_VERSION_CODE >= VERSION_CODE(2026, 0, 0)  // Code for ESPHome newer than v2026.0.0
          ESP_LOGCONFIG("${TAG_HW_RELAYS}", "  Relay 2: %s", sl_relay_2_light_mode->current_option().c_str());
          #else
          ESP_LOGCONFIG("${TAG_HW_RELAYS}", "  Relay 2: %s", sl_relay_2_light_mode->current_option());
          #endif
          #endif  // TX_ULTIMATE_EASY_GANG_COUNT >= 2
          #if TX_ULTIMATE_EASY_GANG_COUNT >= 3
          #if ESPHOME_VERSION_CODE >= VERSION_CODE(2026, 0, 0)  // Code for ESPHome newer than v2026.0.0
          ESP_LOGCONFIG("${TAG_HW_RELAYS}", "  Relay 3: %s", sl_relay_3_light_mode->current_option().c_str());
          #else
          ESP_LOGCONFIG("${TAG_HW_RELAYS}", "  Relay 3: %s", sl_relay_3_light_mode->current_option());
          #endif
          #endif  // TX_ULTIMATE_EASY_GANG_COUNT >= 3
          #if TX_ULTIMATE_EASY_GANG_COUNT >= 4
          #if ESPHOME_VERSION_CODE >= VERSION_CODE(2026, 0, 0)  // Code for ESPHome newer than v2026.0.0
          ESP_LOGCONFIG("${TAG_HW_RELAYS}", "  Relay 4: %s", sl_relay_4_light_mode->current_option().c_str());
          #else
          ESP_LOGCONFIG("${TAG_HW_RELAYS}", "  Relay 4: %s", sl_relay_4_light_mode->current_option());
          #endif
          #endif  // TX_ULTIMATE_EASY_GANG_COUNT >= 4

  - id: !extend dump_config_list_packages
    then:
      - script.wait: dump_config
      - lambda: |-
          // Check for requirements
          #ifndef TX_ULTIMATE_EASY_COMMON
            #error "The package TX-Ultimate-Easy-ESPHome_common.yaml is required."
          #endif
          #ifndef TX_ULTIMATE_EASY_HW_LEDS
            #error "The package TX-Ultimate-Easy-ESPHome_hw_leds.yaml is required."
          #endif  // TX_ULTIMATE_EASY_HW_LEDS

          // Identify itself
          ESP_LOGCONFIG(ESPHOME_PROJECT_NAME, "  - Hardware - Relays");

  - id: light_set_state
    mode: parallel
    parameters:
      light_group: uint8_t
      light_index: uint8_t
      state: bool
    then:
      - lambda: |-
          ESP_LOGV("${TAG_HW_RELAYS}", "script: light_set_state");
          ESP_LOGV("${TAG_HW_RELAYS}", "  light_group: %" PRIu8, light_group);
          ESP_LOGV("${TAG_HW_RELAYS}", "  light_index: %" PRIu8, light_index);
          ESP_LOGV("${TAG_HW_RELAYS}", "  state: %s", ONOFF(state));

          static const uint32_t LIGHT_TRANSITION_TURN_ON = ${LIGHT_TRANSITION_TURN_ON};
          static const uint32_t LIGHT_TRANSITION_TURN_OFF = ${LIGHT_TRANSITION_TURN_OFF};
          static const uint8_t LIGHT_BRIGHTNESS_TURN_ON = ${LIGHT_BRIGHTNESS_TURN_ON};

          switch (light_group) {
            case 1:
              if (light_index >= id(gb_lights_1).size()) {
                ESP_LOGE("${TAG_HW_RELAYS}",
                          "Invalid set with ${LIGHT_MODE_BOTTOM_OR_LEFT_TEXT} light for Relay %" PRIu8, light_index+1);
                return;
              }
              if (state and !id(gb_lights_1)[light_index]->current_values.is_on()) {
                ESP_LOGI("${TAG_HW_RELAYS}",
                          "Turn-on ${LIGHT_MODE_BOTTOM_OR_LEFT_TEXT} light for Relay %" PRIu8, light_index+1);
                auto call = id(gb_lights_1)[light_index]->turn_on();
                if (LIGHT_TRANSITION_TURN_ON > 0)
                  call.set_transition_length(LIGHT_TRANSITION_TURN_ON);  // in ms
                if (LIGHT_BRIGHTNESS_TURN_ON > 0 and LIGHT_BRIGHTNESS_TURN_ON <= 100)
                  call.set_brightness(LIGHT_BRIGHTNESS_TURN_ON / 100.0f);
                call.perform();
              } else if (!state and id(gb_lights_1)[light_index]->current_values.is_on()) {
                ESP_LOGI("${TAG_HW_RELAYS}",
                          "Turn-off ${LIGHT_MODE_BOTTOM_OR_LEFT_TEXT} light for Relay %" PRIu8, light_index+1);
                auto call = id(gb_lights_1)[light_index]->turn_off();
                if (LIGHT_TRANSITION_TURN_OFF > 0)
                  call.set_transition_length(LIGHT_TRANSITION_TURN_OFF);  // in ms
                call.perform();
              }
              break;
            case 2:
              if (light_index >= id(gb_lights_2).size()) {
                ESP_LOGE("${TAG_HW_RELAYS}",
                          "Invalid set with ${LIGHT_MODE_TOP_OR_RIGHT_TEXT} light for Relay %" PRIu8, light_index+1);
                return;
              }
              if (state and !id(gb_lights_2)[light_index]->current_values.is_on()) {
                ESP_LOGI("${TAG_HW_RELAYS}",
                          "Turn-on ${LIGHT_MODE_TOP_OR_RIGHT_TEXT} light for Relay %" PRIu8, light_index+1);
                auto call = id(gb_lights_2)[light_index]->turn_on();
                if (LIGHT_TRANSITION_TURN_ON > 0)
                  call.set_transition_length(LIGHT_TRANSITION_TURN_ON);  // in ms
                if (LIGHT_BRIGHTNESS_TURN_ON > 0 and LIGHT_BRIGHTNESS_TURN_ON <= 100)
                  call.set_brightness(LIGHT_BRIGHTNESS_TURN_ON / 100.0f);
                call.perform();
              } else if (!state and id(gb_lights_2)[light_index]->current_values.is_on()) {
                ESP_LOGI("${TAG_HW_RELAYS}",
                          "Turn-off ${LIGHT_MODE_TOP_OR_RIGHT_TEXT} light for Relay %" PRIu8, light_index+1);
                auto call = id(gb_lights_2)[light_index]->turn_off();
                if (LIGHT_TRANSITION_TURN_OFF > 0)
                  call.set_transition_length(LIGHT_TRANSITION_TURN_OFF);  // in ms
                call.perform();
              }
              break;
            default:
              ESP_LOGE("${TAG_HW_RELAYS}", "Invalid light_group=%" PRIu8 " (expected 1 or 2)", light_group);
              break;
          }

  - id: show_relay_status
    mode: restart
    then:
      - script.wait: boot_initialize_relays
      - lambda: |-
          if (not id(boot_initialization_relays)) {
            ESP_LOGW("${TAG_HW_RELAYS}", "Relays not initialized yet");
            if (not boot_initialize_relays->is_running())
              boot_initialize_relays->execute();
            return;
          }
          for (uint8_t i = 0; i < ${gang_count}; i++) {
            bool relay_state = false;
            std::string light_mode;

            // Determine relay state and light mode
            switch (i) {
              case 0:
                relay_state = id(relay_1_state);
                light_mode = sl_relay_1_light_mode->current_option();
                break;
              case 1:
                relay_state = id(relay_2_state);
                light_mode = sl_relay_2_light_mode->current_option();
                break;
              case 2:
                relay_state = id(relay_3_state);
                light_mode = sl_relay_3_light_mode->current_option();
                break;
              case 3:
                relay_state = id(relay_4_state);
                light_mode = sl_relay_4_light_mode->current_option();
                break;
            }

            ESP_LOGV("${TAG_HW_RELAYS}", "Relay %" PRIu8 " is %s", i + 1, relay_state ? "ON" : "OFF");
            ESP_LOGV("${TAG_HW_RELAYS}", "Light Mode for Relay %" PRIu8 ": %s", i + 1, light_mode.c_str());

            // Use light_set_state for light updates
            if (light_mode != "${LIGHT_MODE_DISABLED_TEXT}") {
              if (light_mode == "${LIGHT_MODE_BOTTOM_OR_LEFT_TEXT}" || light_mode == "${LIGHT_MODE_BOTH_TEXT}") {
                light_set_state->execute(1, i, relay_state);  // Left/bottom light
              }
              if (light_mode == "${LIGHT_MODE_TOP_OR_RIGHT_TEXT}" || light_mode == "${LIGHT_MODE_BOTH_TEXT}") {
                light_set_state->execute(2, i, relay_state);  // Right/top light
              }
            }
          }

select:
  - &relay_light_mode
    id: sl_relay_1_light_mode
    name: Relay 1 light mode
    platform: template
    options:
      - "${LIGHT_MODE_DISABLED_TEXT}"
      - "${LIGHT_MODE_BOTTOM_OR_LEFT_TEXT}"
      - "${LIGHT_MODE_TOP_OR_RIGHT_TEXT}"
      - "${LIGHT_MODE_BOTH_TEXT}"
    initial_option: "${LIGHT_MODE_BOTTOM_OR_LEFT_TEXT}"
    optimistic: true
    restore_value: false
    internal: ${gang_count < 1}
    entity_category: config
    disabled_by_default: false
    icon: mdi:dots-square
    on_value:
      - lambda: |-
          // Handle mode transitions (only after boot is complete)
          if (!id(bs_boot_completed)->state) return;  // Skip during boot

          static std::string previous_mode = "";  // Static variable local to THIS lambda only
          std::string current_mode = x;

          if (previous_mode.empty()) {
            previous_mode = current_mode;  // Initialize on first run after boot
            return;
          }

          if (previous_mode != "${LIGHT_MODE_DISABLED_TEXT}" && current_mode == "${LIGHT_MODE_DISABLED_TEXT}") {
            // Transitioning TO Disabled - turn off lights
            ESP_LOGI("${TAG_HW_RELAYS}",
                      "Relay 1 light mode changed to ${LIGHT_MODE_DISABLED_TEXT} - turning off lights");
            id(light_set_state)->execute(1, 0, false);  // Group 1, relay index 0
            id(light_set_state)->execute(2, 0, false);  // Group 2, relay index 0
          } else if (previous_mode == "${LIGHT_MODE_DISABLED_TEXT}" && current_mode != "${LIGHT_MODE_DISABLED_TEXT}") {
            // Transitioning FROM Disabled - update lights based on relay state
            ESP_LOGI("${TAG_HW_RELAYS}",
                      "Relay 1 light mode changed from ${LIGHT_MODE_DISABLED_TEXT} - updating lights");
            bool relay_state = id(sw_relay_1).state;
            if (current_mode == "${LIGHT_MODE_BOTTOM_OR_LEFT_TEXT}" || current_mode == "${LIGHT_MODE_BOTH_TEXT}") {
              id(light_set_state)->execute(1, 0, relay_state);
            }
            if (current_mode == "${LIGHT_MODE_TOP_OR_RIGHT_TEXT}" || current_mode == "${LIGHT_MODE_BOTH_TEXT}") {
              id(light_set_state)->execute(2, 0, relay_state);
            }
          }

          previous_mode = current_mode;

  - id: sl_relay_1_mode
    name: Relay 1 display mode
    platform: template
    options:
      - "${RELAY_MODE_TEXT_SWITCH}"
      - "${RELAY_MODE_TEXT_LIGHT}"
      - "${RELAY_MODE_TEXT_NOT_USED}"
    initial_option: "${RELAY_MODE_TEXT_SWITCH}"
    optimistic: true
    restore_value: true
    internal: ${gang_count < 1}
    entity_category: config
    disabled_by_default: false
    icon: mdi:dip-switch
    on_value:
      then:
        - lambda: |-
            bs_pending_restart->publish_state(true);

  - id: sl_relay_2_light_mode
    name: Relay 2 light mode
    internal: ${gang_count < 2}
    <<: *relay_light_mode
    on_value:
      - lambda: |-
          // Handle mode transitions (only after boot is complete)
          if (!id(bs_boot_completed)->state) return;  // Skip during boot

          static std::string previous_mode = "";
          std::string current_mode = x;

          if (previous_mode.empty()) {
            previous_mode = current_mode;  // Initialize on first run after boot
            return;
          }

          if (previous_mode != "${LIGHT_MODE_DISABLED_TEXT}" && current_mode == "${LIGHT_MODE_DISABLED_TEXT}") {
            // Transitioning TO Disabled - turn off lights
            ESP_LOGI("${TAG_HW_RELAYS}",
                      "Relay 2 light mode changed to ${LIGHT_MODE_DISABLED_TEXT} - turning off lights");
            id(light_set_state)->execute(1, 1, false);  // Group 1, relay index 1
            id(light_set_state)->execute(2, 1, false);  // Group 2, relay index 1
          } else if (previous_mode == "${LIGHT_MODE_DISABLED_TEXT}" && current_mode != "${LIGHT_MODE_DISABLED_TEXT}") {
            // Transitioning FROM Disabled - update lights based on relay state
            ESP_LOGI("${TAG_HW_RELAYS}",
                      "Relay 2 light mode changed from ${LIGHT_MODE_DISABLED_TEXT} - updating lights");
            bool relay_state = id(sw_relay_2).state;
            if (current_mode == "${LIGHT_MODE_BOTTOM_OR_LEFT_TEXT}" || current_mode == "${LIGHT_MODE_BOTH_TEXT}") {
              id(light_set_state)->execute(1, 1, relay_state);
            }
            if (current_mode == "${LIGHT_MODE_TOP_OR_RIGHT_TEXT}" || current_mode == "${LIGHT_MODE_BOTH_TEXT}") {
              id(light_set_state)->execute(2, 1, relay_state);
            }
          }

          previous_mode = current_mode;

  - id: sl_relay_2_mode
    name: Relay 2 display mode
    platform: template
    options:
      - "${RELAY_MODE_TEXT_SWITCH}"
      - "${RELAY_MODE_TEXT_LIGHT}"
      - "${RELAY_MODE_TEXT_NOT_USED}"
    initial_option: "${RELAY_MODE_TEXT_SWITCH}"
    optimistic: true
    restore_value: true
    internal: ${gang_count < 2}
    entity_category: config
    disabled_by_default: false
    icon: mdi:dip-switch
    on_value:
      then:
        - lambda: |-
            bs_pending_restart->publish_state(true);

  - id: sl_relay_3_light_mode
    name: Relay 3 light mode
    internal: ${gang_count < 3}
    <<: *relay_light_mode
    on_value:
      - lambda: |-
          // Handle mode transitions (only after boot is complete)
          if (!id(bs_boot_completed)->state) return;  // Skip during boot

          static std::string previous_mode = "";
          std::string current_mode = x;

          if (previous_mode.empty()) {
            previous_mode = current_mode;  // Initialize on first run after boot
            return;
          }

          if (previous_mode != "${LIGHT_MODE_DISABLED_TEXT}" && current_mode == "${LIGHT_MODE_DISABLED_TEXT}") {
            // Transitioning TO Disabled - turn off lights
            ESP_LOGI("${TAG_HW_RELAYS}",
                      "Relay 3 light mode changed to ${LIGHT_MODE_DISABLED_TEXT} - turning off lights");
            id(light_set_state)->execute(1, 2, false);  // Group 1, relay index 2
            id(light_set_state)->execute(2, 2, false);  // Group 2, relay index 2
          } else if (previous_mode == "${LIGHT_MODE_DISABLED_TEXT}" && current_mode != "${LIGHT_MODE_DISABLED_TEXT}") {
            // Transitioning FROM Disabled - update lights based on relay state
            ESP_LOGI("${TAG_HW_RELAYS}",
                      "Relay 3 light mode changed from ${LIGHT_MODE_DISABLED_TEXT} - updating lights");
            bool relay_state = id(sw_relay_3).state;
            if (current_mode == "${LIGHT_MODE_BOTTOM_OR_LEFT_TEXT}" || current_mode == "${LIGHT_MODE_BOTH_TEXT}") {
              id(light_set_state)->execute(1, 2, relay_state);
            }
            if (current_mode == "${LIGHT_MODE_TOP_OR_RIGHT_TEXT}" || current_mode == "${LIGHT_MODE_BOTH_TEXT}") {
              id(light_set_state)->execute(2, 2, relay_state);
            }
          }

          previous_mode = current_mode;

  - id: sl_relay_3_mode
    name: Relay 3 display mode
    platform: template
    options:
      - "${RELAY_MODE_TEXT_SWITCH}"
      - "${RELAY_MODE_TEXT_LIGHT}"
      - "${RELAY_MODE_TEXT_NOT_USED}"
    initial_option: "${RELAY_MODE_TEXT_SWITCH}"
    optimistic: true
    restore_value: true
    internal: ${gang_count < 3}
    entity_category: config
    disabled_by_default: false
    icon: mdi:dip-switch
    on_value:
      then:
        - lambda: |-
            bs_pending_restart->publish_state(true);

  - id: sl_relay_4_light_mode
    name: Relay 4 light mode
    internal: ${gang_count < 4}
    <<: *relay_light_mode
    on_value:
      - lambda: |-
          // Handle mode transitions (only after boot is complete)
          if (!id(bs_boot_completed)->state) return;  // Skip during boot

          static std::string previous_mode = "";
          std::string current_mode = x;

          if (previous_mode.empty()) {
            previous_mode = current_mode;  // Initialize on first run after boot
            return;
          }

          if (previous_mode != "${LIGHT_MODE_DISABLED_TEXT}" && current_mode == "${LIGHT_MODE_DISABLED_TEXT}") {
            // Transitioning TO Disabled - turn off lights
            ESP_LOGI("${TAG_HW_RELAYS}", "Relay 4 light mode changed to ${LIGHT_MODE_DISABLED_TEXT} - turning off lights");
            id(light_set_state)->execute(1, 3, false);  // Group 1, relay index 3
            id(light_set_state)->execute(2, 3, false);  // Group 2, relay index 3
          } else if (previous_mode == "${LIGHT_MODE_DISABLED_TEXT}" && current_mode != "${LIGHT_MODE_DISABLED_TEXT}") {
            // Transitioning FROM Disabled - update lights based on relay state
            ESP_LOGI("${TAG_HW_RELAYS}", "Relay 4 light mode changed from ${LIGHT_MODE_DISABLED_TEXT} - updating lights");
            bool relay_state = id(sw_relay_4).state;
            if (current_mode == "${LIGHT_MODE_BOTTOM_OR_LEFT_TEXT}" || current_mode == "${LIGHT_MODE_BOTH_TEXT}") {
              id(light_set_state)->execute(1, 3, relay_state);
            }
            if (current_mode == "${LIGHT_MODE_TOP_OR_RIGHT_TEXT}" || current_mode == "${LIGHT_MODE_BOTH_TEXT}") {
              id(light_set_state)->execute(2, 3, relay_state);
            }
          }

          previous_mode = current_mode;

  - id: sl_relay_4_mode
    name: Relay 4 display mode
    platform: template
    options:
      - "${RELAY_MODE_TEXT_SWITCH}"
      - "${RELAY_MODE_TEXT_LIGHT}"
      - "${RELAY_MODE_TEXT_NOT_USED}"
    initial_option: "${RELAY_MODE_TEXT_SWITCH}"
    optimistic: true
    restore_value: true
    internal: ${gang_count < 4}
    entity_category: config
    disabled_by_default: false
    icon: mdi:dip-switch
    on_value:
      then:
        - lambda: |-
            bs_pending_restart->publish_state(true);

switch:
  - id: sw_relay_1
    name: Relay 1
    internal: ${gang_count < 1}
    platform: template
    lambda: |-
      return id(relay_1_state);
    turn_on_action:
      - lambda: id(relay_1_state) = true;
      - light.turn_on: light_output_1
    turn_off_action:
      - lambda: id(relay_1_state) = false;
      - light.turn_off: light_output_1

  - id: sw_relay_2
    name: Relay 2
    internal: ${gang_count < 2}
    platform: template
    lambda: |-
      return id(relay_2_state);
    turn_on_action:
      - lambda: id(relay_2_state) = true;
      - light.turn_on: light_output_2
    turn_off_action:
      - lambda: id(relay_2_state) = false;
      - light.turn_off: light_output_2

  - id: sw_relay_3
    name: Relay 3
    internal: ${gang_count < 3}
    platform: template
    lambda: |-
      return id(relay_3_state);
    turn_on_action:
      - lambda: id(relay_3_state) = true;
      - light.turn_on: light_output_3
    turn_off_action:
      - lambda: id(relay_3_state) = false;
      - light.turn_off: light_output_3

  - id: sw_relay_4
    name: Relay 4
    internal: ${gang_count < 4}
    platform: template
    lambda: |-
      return id(relay_4_state);
    turn_on_action:
      - lambda: id(relay_4_state) = true;
      - light.turn_on: light_output_4
    turn_off_action:
      - lambda: id(relay_4_state) = false;
      - light.turn_off: light_output_4
...
